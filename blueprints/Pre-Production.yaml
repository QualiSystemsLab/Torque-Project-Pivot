spec_version: 1
kind: blueprint
metadata:
  description: >
    All in one deployment of our promotions manager on AWS
    
clouds: 
  - AWS-Dev: us-east-1
  
artifacts:
  - promotions-manager-ui: artifacts/latest/promotions-manager-ui.master.tar.gz
  - promotions-manager-api: artifacts/latest/promotions-manager-api.master.tar.gz

inputs:
- PORT: 3000
- API_PORT: 3001
- AWS_INSTANCE_TYPE: m5.large
- RELEASE_NUMBER: none
- API_BUILD_NUMBER: none
- DB_USER: root  # Used to define the db admin account
- DB_PASS:
    display_style: masked
    description: please set the root database password
    default_value: Torque!123
  # Used to define the db admin password
- DB_NAME: demo_db  # DB_NAME - a target database name

applications:
  - promotions-manager-ui:
      input_values:
        - PORT: $PORT
        - AWS_INSTANCE_TYPE: $AWS_INSTANCE_TYPE
        - API_PORT: $API_PORT
    
  - promotions-manager-api:      
      input_values:
        - API_PORT: $API_PORT
        - AWS_INSTANCE_TYPE: $AWS_INSTANCE_TYPE
        - DATABASE_HOST: $torque.services.rds-mysql.outputs.hostname
        - RELEASE_NUMBER: $RELEASE_NUMBER
        - API_BUILD_NUMBER: $API_BUILD_NUMBER
      depends_on: 
        - rds-mysql

services:
  - rds-mysql:  # One instance of mysql (see: services/rds-mysql/rds-mysql.yaml)
      input_values:
        - DB_NAME: $DB_NAME
        - DB_USER: $DB_USER
        - DB_PASS: $DB_PASS
        - SANDBOX_ID: $torque.environment.id
        - VPC_ID: $torque.environment.virtual_network_id  # Sandbox VPC Id
debugging:
  bastion_availability: enabled-on